<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java并发编程笔记 | Longqinx&#39;s Notes</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.9f84806b.css" as="style"><link rel="preload" href="/assets/js/app.969a6014.js" as="script"><link rel="preload" href="/assets/js/2.0c4bddf9.js" as="script"><link rel="preload" href="/assets/js/1.50b457b8.js" as="script"><link rel="preload" href="/assets/js/33.e9f62ae9.js" as="script"><link rel="prefetch" href="/assets/js/10.325b9f09.js"><link rel="prefetch" href="/assets/js/11.845e3692.js"><link rel="prefetch" href="/assets/js/12.ecdb524b.js"><link rel="prefetch" href="/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/assets/js/15.b60f3925.js"><link rel="prefetch" href="/assets/js/16.85253907.js"><link rel="prefetch" href="/assets/js/17.c2838453.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/20.10e47ab9.js"><link rel="prefetch" href="/assets/js/21.33b300c9.js"><link rel="prefetch" href="/assets/js/22.271589f5.js"><link rel="prefetch" href="/assets/js/23.f187cd00.js"><link rel="prefetch" href="/assets/js/24.25d46f1d.js"><link rel="prefetch" href="/assets/js/25.6dbe905b.js"><link rel="prefetch" href="/assets/js/26.be06b78c.js"><link rel="prefetch" href="/assets/js/27.c1cdaecc.js"><link rel="prefetch" href="/assets/js/28.c84982d2.js"><link rel="prefetch" href="/assets/js/29.75d6d01f.js"><link rel="prefetch" href="/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/assets/js/30.dfc04b59.js"><link rel="prefetch" href="/assets/js/31.e768d834.js"><link rel="prefetch" href="/assets/js/32.bd424b57.js"><link rel="prefetch" href="/assets/js/34.6e660565.js"><link rel="prefetch" href="/assets/js/35.259ec1af.js"><link rel="prefetch" href="/assets/js/36.cabec235.js"><link rel="prefetch" href="/assets/js/37.62de5401.js"><link rel="prefetch" href="/assets/js/38.65324daa.js"><link rel="prefetch" href="/assets/js/39.d859ec36.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.3d954b2a.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f84806b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Longqinx's Notes" class="logo"> <span class="site-name can-hide">Longqinx's Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/c++/" class="nav-link">
  C/C++
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/dsa/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/project/" class="nav-link">
  我的小项目
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/contactMe.html" class="nav-link">
  联系我
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/c++/" class="nav-link">
  C/C++
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/dsa/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/project/" class="nav-link">
  我的小项目
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/contactMe.html" class="nav-link">
  联系我
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java并发编程笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#原子操作实现原理" class="sidebar-link">原子操作实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#总线锁保证原子性" class="sidebar-link">总线锁保证原子性</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#缓存锁保证原子性" class="sidebar-link">缓存锁保证原子性</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java中原子操作的实现" class="sidebar-link">Java中原子操作的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#使用循环cas实现原子操作" class="sidebar-link">使用循环CAS实现原子操作</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#cas实现原子操作的三大问题" class="sidebar-link">CAS实现原子操作的三大问题</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#指令重排序" class="sidebar-link">指令重排序</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#happens-before规则" class="sidebar-link">Happens-before规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#volatile内存语义" class="sidebar-link">volatile内存语义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#volatile变量的特性" class="sidebar-link">volatile变量的特性</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#volatile写-读建立的happens-before关系" class="sidebar-link">volatile写-读建立的happens-before关系</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#双重检查锁定与延迟初始化" class="sidebar-link">双重检查锁定与延迟初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#双重检查锁定的发展过程" class="sidebar-link">双重检查锁定的发展过程</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#安全延迟初始化的两种方案" class="sidebar-link">安全延迟初始化的两种方案</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java线程基础" class="sidebar-link">Java线程基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#线程状态" class="sidebar-link">线程状态</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#关于中断" class="sidebar-link">关于中断</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#安全终止线程" class="sidebar-link">安全终止线程</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#等待-wait-通知-notify-机制进行线程通信" class="sidebar-link">等待(wait)/通知(notify)机制进行线程通信</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#管道输入-输出流" class="sidebar-link">管道输入/输出流</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#threadlocal使用" class="sidebar-link">ThreadLocal使用</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#线程应用实例" class="sidebar-link">线程应用实例</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java中的锁" class="sidebar-link">Java中的锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#lock接口" class="sidebar-link">Lock接口</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#队列同步器-abstractqueuedsynchronizer" class="sidebar-link">队列同步器(AbstractQueuedSynchronizer)</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#队列同步器的接口" class="sidebar-link">队列同步器的接口</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#队列同步器的实现" class="sidebar-link">队列同步器的实现</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#队列同步器使用实例-twinslock" class="sidebar-link">队列同步器使用实例——TwinsLock</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#重入锁" class="sidebar-link">重入锁</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#读写锁" class="sidebar-link">读写锁</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#读写锁的实现" class="sidebar-link">读写锁的实现</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#locksupport工具" class="sidebar-link">LockSupport工具</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#condition接口" class="sidebar-link">Condition接口</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#condition的实现" class="sidebar-link">Condition的实现</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java并发容器与框架" class="sidebar-link">Java并发容器与框架</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#concurrenthashmap" class="sidebar-link">ConcurrentHashMap</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#concurrentlinkedqueue" class="sidebar-link">ConcurrentLinkedQueue</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java中的阻塞队列" class="sidebar-link">Java中的阻塞队列</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#fork-join框架" class="sidebar-link">Fork/Join框架</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java中的12个原子操作类" class="sidebar-link">Java中的12个原子操作类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#原子更新基本类型" class="sidebar-link">原子更新基本类型</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#原子更新数组" class="sidebar-link">原子更新数组</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#原子更新引用类型" class="sidebar-link">原子更新引用类型</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#原子更新字段" class="sidebar-link">原子更新字段</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java中的并发工具类" class="sidebar-link">Java中的并发工具类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#countdownlatch" class="sidebar-link">CountDownLatch</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#cyclicbarrier" class="sidebar-link">CyclicBarrier</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#semaphore" class="sidebar-link">Semaphore</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#exchanger" class="sidebar-link">Exchanger</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#java中的线程池" class="sidebar-link">Java中的线程池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#线程池的创建" class="sidebar-link">线程池的创建</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#向线程池提交任务" class="sidebar-link">向线程池提交任务</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#关闭线程池" class="sidebar-link">关闭线程池</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#线程池的监控" class="sidebar-link">线程池的监控</a></li><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#附加-源码中的解释" class="sidebar-link">附加：源码中的解释</a></li></ul></li><li><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#executor框架" class="sidebar-link">Executor框架</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/Java%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0.html#executor框架的结构与成员" class="sidebar-link">Executor框架的结构与成员</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="java并发编程笔记"><a href="#java并发编程笔记" class="header-anchor">#</a> Java并发编程笔记</h1> <h2 id="原子操作实现原理"><a href="#原子操作实现原理" class="header-anchor">#</a> 原子操作实现原理</h2> <ul><li>32位IA-32处理器使用基于对<strong>缓存加锁</strong>和<strong>总线加锁</strong>两种方式保证原子性</li></ul> <h3 id="总线锁保证原子性"><a href="#总线锁保证原子性" class="header-anchor">#</a> 总线锁保证原子性</h3> <ul><li>使用处理器提供的一个<code>LOCK#</code>信号，使得一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞，该处理器就可以独占共享内存</li></ul> <h3 id="缓存锁保证原子性"><a href="#缓存锁保证原子性" class="header-anchor">#</a> 缓存锁保证原子性</h3> <ul><li>总线锁的开销较大，因为原子性一般仅要求在写某个地址的时候的原子性，其他地址的内存可以被写。</li> <li>但锁总线会让其他处理器甚至无法写目标区域外的内存位置</li> <li>因此缓存锁效率更好</li> <li>缓存一致性机制会阻止同时修改两个以上处理器缓存的内存区域数据，其他处理器回写已被锁定的缓存行时，会让缓存行无效</li></ul> <h2 id="java中原子操作的实现"><a href="#java中原子操作的实现" class="header-anchor">#</a> Java中原子操作的实现</h2> <ul><li>在Java中可以通过锁和循环CAS方式来实现原子操作</li></ul> <h3 id="使用循环cas实现原子操作"><a href="#使用循环cas实现原子操作" class="header-anchor">#</a> 使用循环CAS实现原子操作</h3> <ul><li><p>CAS,即 Compare And Swap</p></li> <li><p>Java中的CAS利用处理器提供的<code>CMPXCHG</code>指令实现</p></li> <li><p>自旋CAS即循环进行CAS操作直到成功为止</p></li> <li><p>示例：CAS安全计数器和普通计数器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 使用支持原子操作的AtomicInteger实现线程安全的计数器
     * 自旋CAS
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">safeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> i<span class="token operator">=</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 没有任何同步的普通的自增操作，不保证线程安全
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Counter</span> myCounter<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> threads<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> start<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用一百个线程并发计数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    myCounter<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    myCounter<span class="token punctuation">.</span><span class="token function">safeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            threads<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> thread<span class="token operator">:</span>threads<span class="token punctuation">)</span><span class="token punctuation">{</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span> h<span class="token operator">:</span>threads<span class="token punctuation">)</span><span class="token punctuation">{</span>
            h<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用时：&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;普通计数器：&quot;</span><span class="token operator">+</span>myCounter<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CAS计数器：&quot;</span><span class="token operator">+</span>myCounter<span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="cas实现原子操作的三大问题"><a href="#cas实现原子操作的三大问题" class="header-anchor">#</a> CAS实现原子操作的三大问题</h3> <ul><li><strong>ABA问题</strong> <ul><li>描述：CAS本质上是在操作时比较之前获取的值和在操作的时候的值是否没有变化，若没有变化则认为在此之前没有其他线程修改过当前值。但是，存在一种情况，即另一个线程先修改了A的值为B，后来又修改B为A，值在这期间发生了变化，但CAS认为这是没变的</li> <li>解决方案：使用版本号，可在变量前追加版本号，每次更新版本号跟着改变。如1A---2B---3A</li> <li>Java1.5开始提供了一个<code>AtomicStampedReference</code>解决ABA问题</li></ul></li> <li><strong>循环时间长开销大</strong> <ul><li>若CAS在循环测试时长时间不成功，会带来较大的CPU开销</li></ul></li> <li><strong>只能保证一个共享变量的原子操作</strong> <ul><li>对多个共享变量进行操作时，循环CAS无法保证操作的原子性，此时可以用锁。</li> <li>Java1.5引入了<code>AtomicReference</code>类，用于保证<strong>引用对象之间的原子性</strong>，因此可以把多个变量放在一个对象中进行CAS操作</li></ul></li></ul> <h2 id="指令重排序"><a href="#指令重排序" class="header-anchor">#</a> 指令重排序</h2> <ul><li>为了提高性能，编译器和处理器常常会对指令做<strong>重排序</strong></li> <li>三类：
<ul><li><strong>编译器优化的重排序</strong>：不改变单线程语义的情况下重新安排语句执行顺序</li> <li><strong>指令级并行的重排序</strong>：现代处理器采用了指令级并行技术，将多条指令重叠执行。若数据不存在依赖性，则可以改变对应机器指令的执行顺序</li> <li><strong>内存系统的重排序</strong>：因为处理器使用缓存和读写缓冲区，使得加载和存储操作看上去可能是乱序执行</li></ul></li> <li>前一种属于编译器重排序，后两个属于处理器重排序</li> <li>对于编译器重排序，JMM重排规则会禁止特定的重排</li> <li>对于处理器重排序，需要Java编译器生成指令序列时插入特定的**内存屏障(Memory Barriers)**来禁止特定类型的处理器排序</li></ul> <h2 id="happens-before规则"><a href="#happens-before规则" class="header-anchor">#</a> Happens-before规则</h2> <ul><li>JDK5开始使用新的JSR-133内存模型，其使用happens-before规则阐述操作之间的内存可见性</li> <li>与程序员相关的happens-before规则：
<ul><li>**程序顺序规则：**一个线程中的每个操作，happens-before该线程中的任意后续操作</li> <li>**监视器锁规则：**对一个锁的解锁，happens-before与随后对这个锁的加锁</li> <li>**volatile变量规则：**对一个volatile域的写，happens-before于任意后续对这个volatile的读</li> <li>**传递性规则：**若A happens-before B，B happens-before C，则A happens-before C</li></ul></li></ul> <h2 id="volatile内存语义"><a href="#volatile内存语义" class="header-anchor">#</a> volatile内存语义</h2> <h3 id="volatile变量的特性"><a href="#volatile变量的特性" class="header-anchor">#</a> volatile变量的特性</h3> <ul><li>可见性：对一个volatile变量的读，总是能看到对这个volatile的最后的写入</li> <li>原子性：对任意单个volatile变量的操作具有原子性，如等号赋值。但对于i++等复合操作不具有原子性</li></ul> <h3 id="volatile写-读建立的happens-before关系"><a href="#volatile写-读建立的happens-before关系" class="header-anchor">#</a> volatile写-读建立的happens-before关系</h3> <ul><li>从JSR-133开始volatile变量的写-读能实现线程之间的通信</li></ul> <h2 id="双重检查锁定与延迟初始化"><a href="#双重检查锁定与延迟初始化" class="header-anchor">#</a> 双重检查锁定与延迟初始化</h2> <ul><li>双重锁定(Double-Checked Locking,DCL)是常见的延迟初始化技术，但常见的双重锁定写法存在错误</li></ul> <h3 id="双重检查锁定的发展过程"><a href="#双重检查锁定的发展过程" class="header-anchor">#</a> 双重检查锁定的发展过程</h3> <ul><li><p>普通的<strong>非线程安全</strong>的单例类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//延迟初始化的单例，懒汉式</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
            instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>加锁保证线程安全</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//加锁之后能保证线程安全</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
            instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>synchronized同步带来的问题：</p> <ul><li>synchronized同步本身会带来较大的性能开销(以前重量级锁时开销较大，优化后好了一些)，若<code>getInstance()</code>方法被频繁地调用，将会导致程序性能地明显下降</li></ul></li> <li><p>双重检查锁定的出现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//DCL</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//去掉了每次同步</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>				<span class="token comment">//先判断非空再进入内部进行加锁，避免每次都对此方法进行同步带来的性能损失</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                    instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>上述双重检查锁定潜在的问题</p> <ul><li>在逻辑上上述代码几乎没有问题。但是考虑到编译器和处理器的重排机制，若A线程实现instance的初始化，而此时B正好判断非空条件，因为初始化分为分配空间、初始化对象、设置instance指向的分配地址三个过程，假设A在初始化时三个顺序被重排，变为
<ol><li>分配空间</li> <li>设置instance指向地址</li> <li>初始化对象</li></ol></li> <li>则当B进行非空判断时有可能得到一个设置了地址(非空)但却还没有完全被A初始化的instance对象，造成错误</li></ul></li></ul> <h3 id="安全延迟初始化的两种方案"><a href="#安全延迟初始化的两种方案" class="header-anchor">#</a> 安全延迟初始化的两种方案</h3> <ul><li><p>不允许初始化对象和设置对象地址两个步骤重排</p></li> <li><p>允许重排，但对其他线程不可见。（即将两个过程看成类似原子的操作）</p></li> <li><p><strong>基于volatile的解决方案</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span><span class="token comment">//将 instance 设置为 volatile 类型之后不允许重排。(写不能重排到读后)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>				
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                    instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>基于类初始化的解决方案</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstanceFactory</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InstanceHolder</span><span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Instance</span> instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Instance</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">InstanceHolder</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span> <span class="token comment">//此处会让InstanceHolder类初始化</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>JVM在类的初始化阶段(Class文件加载后，被线程使用前)会执行类的初始化，此期间，JVM会获取一个锁，该锁可以同步多个线程对类的初始化</li></ul></li></ul> <h2 id="java线程基础"><a href="#java线程基础" class="header-anchor">#</a> Java线程基础</h2> <h3 id="线程状态"><a href="#线程状态" class="header-anchor">#</a> 线程状态</h3> <ul><li><p>Java线程在运行的生命周期中可能处于6种不同的状态中的一种</p></li> <li><p>Java线程状态表:</p> <table><thead><tr><th>状态名</th> <th>描述</th></tr></thead> <tbody><tr><td>NEW</td> <td>初始(新建)状态，线程被构建，但还没有调用start()</td></tr> <tr><td>RUNNABLE</td> <td>运行(可运行)状态，包含了操作系统中的“就绪”和“运行”两种</td></tr> <tr><td>BLOCKED</td> <td>阻塞状态，表示阻塞于锁</td></tr> <tr><td>WAITING</td> <td>等待状态，需要等待其他线程做出一些动作（通知或中断）才能唤醒</td></tr> <tr><td>TIME_WAITING</td> <td>超时等待状态，与WAITING相比而言，在指定时间内没被唤醒可自动唤醒</td></tr> <tr><td>TERMINATED</td> <td>终止状态，表当前线程已经执行完毕</td></tr></tbody></table></li></ul> <h3 id="关于中断"><a href="#关于中断" class="header-anchor">#</a> 关于中断</h3> <ul><li><p>中断(Interrupt)可以理解为线程的一个标识位属性，表示一个运行中的线程是否被其他线程进行了中断操作</p></li> <li><p>中断方式：其他线程调用某线程的<code>interrupt()</code>方法对其进行中断操作</p></li> <li><p>被中断的线程通过<code>isInterrupted()</code>方法来检测自身是否被中断，并对中断作出响应</p></li> <li><p>调用静态方法<code>Thread.interrupted()</code>可以对当前线程的中断标识位进行复位(false)</p></li> <li><p>在Java的API中，许多如<code>Thread.sleep(long)</code>等声明抛出<code>InterruptedException</code>的方法，在抛出异常前，JVM都会<strong>先将当前线程的中断标识位进行复位</strong></p></li> <li><p>示例代码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterruptDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InterruptedThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InterruptedThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;count: &quot;</span><span class="token operator">+</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;计数被中断！计数结束....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;清除标记前：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;测试是否被打断并清除标记：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;标记清除后：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li></ul> <h3 id="安全终止线程"><a href="#安全终止线程" class="header-anchor">#</a> 安全终止线程</h3> <ul><li><p>为了让线程有机会在终止前释放资源，而不是草率地结束线程，需要安全地终止线程</p></li> <li><p>常用的两种方法：</p> <ul><li>中断</li> <li>标志位（volatile类型Boolean变量）</li></ul></li> <li><p>关键代码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> i<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> on<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>on <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        on<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//对上述线程，可通过调用 interrupted() 方法或者 cancel() 方法进行进行终止</span>
</code></pre></div></li></ul> <h3 id="等待-wait-通知-notify-机制进行线程通信"><a href="#等待-wait-通知-notify-机制进行线程通信" class="header-anchor">#</a> 等待(wait)/通知(notify)机制进行线程通信</h3> <ul><li><p>等待/通知机制主要完成“一个线程修改了对象值，另一个线程感知到变化并进行相应操作”的任务，如生产者-消费者模型</p></li> <li><p>不使用等待通知机制的实现方式：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span><span class="token punctuation">(</span>productNum <span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>上述方式中，消费者不断进行判断是否有生产好的产品，若没有，则进行睡眠等待，否则对产品进行相关操作</li> <li>缺陷：
<ul><li>难以保证及时性：可能消费者刚进入睡眠状态就有产品可使用，但消费者线程还是得等待睡眠结束</li> <li>开销可能较大：消费者线程难以及时发现产品数量变化，需要睡眠浪费时间</li></ul></li></ul></li> <li><p>等待/通知机制过程：</p> <ul><li>线程A调用对象O的<code>wait()</code>方法进入等待状态</li> <li>另一个线程B调用对象O的<code>notify()/notifyAll()</code>方法</li> <li>线程A收到通知后从对象O的<code>wait()</code>方法返回，继续后续操作</li></ul></li> <li><p><strong>几个细节</strong></p> <ul><li>使用<code>wait()、notify()、notifyAll()</code>需要先获得调用对象的锁</li> <li>使用<code>wait()</code>后，线程切换为WATING状态，并把当前线程放入对象的等待队列</li> <li><code>notify()/notifyAll()</code>方法调用后，等待线程依旧不会从<code>wait()</code>返回，而需要等到调用通知的线程把锁释放后才有机会返回</li> <li><code>wait()</code>方法返回的<strong>前提</strong>是获得调用对象的锁</li></ul></li> <li><p>示例Demo</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WaitNotifyDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> consumer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> producer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;producer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> product<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>product<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者等待中........&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者消费一个产品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                product<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                product<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者生产一个产品OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="管道输入-输出流"><a href="#管道输入-输出流" class="header-anchor">#</a> 管道输入/输出流</h3> <ul><li><p>管道输入/输出流类似普通的文件输入/输出流，主要用于<strong>线程间传输数据</strong>，媒介为<strong>内存</strong></p></li> <li><p>Java中四个相关类：</p> <ul><li><code>PipedInputStream</code></li> <li><code>PipedOutputStream</code></li> <li><code>PipedReader</code></li> <li><code>PipedWriter</code></li></ul></li> <li><p>利用管道输入/输出流进行线程通信示例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PipedIODemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">PipedReader</span> reader<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PipedReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PipedWriter</span> writer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PipedWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//管道输入输出流要求必须连接才能使用</span>
        writer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> printThread<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Printer</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        printThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//从控制台读入，写到管道中</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receive<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>receive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Printer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PipedReader</span> reader<span class="token punctuation">;</span>
        <span class="token class-name">Printer</span><span class="token punctuation">(</span><span class="token class-name">PipedReader</span> reader<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token operator">=</span>reader<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//从管道中读取数据 并在控制台输出</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receive<span class="token operator">=</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> receive<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="threadlocal使用"><a href="#threadlocal使用" class="header-anchor">#</a> ThreadLocal使用</h3> <ul><li><p>ThreadLocal是线程本地变量，其有类似Map的结构，可看作线程为键，任意对象为值的键值对</p></li> <li><p>ThreadLocal变量被绑定到线程上，一个线程可根据ThreadLocal对象查询到与该线程绑定的一个值</p></li> <li><p>通过<code>set()</code>方法设置值，<code>get()</code>方法获取值</p></li> <li><p>示例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">THREAD_LOCAL</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setThreadLocalValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token constant">THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;-&gt; Before set: &quot;</span><span class="token operator">+</span><span class="token constant">THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setThreadLocalValue</span><span class="token punctuation">(</span><span class="token string">&quot;this is thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;-&gt; After set: &quot;</span><span class="token operator">+</span><span class="token constant">THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;th1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;-&gt; Before set: &quot;</span><span class="token operator">+</span><span class="token constant">THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setThreadLocalValue</span><span class="token punctuation">(</span><span class="token string">&quot;this is thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;-&gt; After set: &quot;</span><span class="token operator">+</span><span class="token constant">THREAD_LOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;th2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="线程应用实例"><a href="#线程应用实例" class="header-anchor">#</a> 线程应用实例</h3> <ul><li><p><strong>等待超时模式</strong></p> <ul><li><p>场景：调用一个方法时等待一段时间，若</p> <ul><li>在给定时间内得到结果，则立即将结果返回</li> <li>否则，返回默认结果</li></ul></li> <li><p>基本结构</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> millis<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
    <span class="token comment">//当前时间点+等待时间=未来超时的时间点</span>
    <span class="token keyword">long</span> future<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>millis<span class="token punctuation">;</span>
    <span class="token keyword">long</span> remaining<span class="token operator">=</span>millis<span class="token punctuation">;</span>
    
    <span class="token comment">//此条件表示：当有结果或超时后则返回，否则继续等待直到超时</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>remaining<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//等待</span>
        <span class="token function">wait</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新剩余时间，看是否超过等待时间</span>
        remaining<span class="token operator">=</span>future<span class="token operator">-</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p><strong>数据库连接池示例</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionPoolDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建线程池</span>
    <span class="token keyword">static</span> <span class="token class-name">ConnectionPool</span> pool<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用于保证所有线程同时开始</span>
    <span class="token keyword">static</span> <span class="token class-name">CountDownLatch</span> start<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">CountDownLatch</span> end<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> threadNum<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
        end<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//轮数</span>
        <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> got<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> notGot<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>threadNum<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectionRunner</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span>got<span class="token punctuation">,</span>notGot<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;ConnectionRunner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        start<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        end<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;总 ：&quot;</span><span class="token operator">+</span>threadNum<span class="token operator">*</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获得连接：&quot;</span><span class="token operator">+</span>got<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;未获得连接：&quot;</span><span class="token operator">+</span>notGot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionRunner</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> count<span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> got<span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> notGot<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">ConnectionRunner</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token class-name">AtomicInteger</span> got<span class="token punctuation">,</span><span class="token class-name">AtomicInteger</span> notGot<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">=</span>count<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>got<span class="token operator">=</span>got<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>notGot<span class="token operator">=</span>notGot<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                start<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Connection</span> connection<span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">fetchConnection</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">//使用通过动态代理的commit方法，会进行一个100ms休眠</span>
                            connection<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            connection<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            <span class="token comment">//使用完后释放连接</span>
                            pool<span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            got<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                        notGot<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    count<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            end<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> pool<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 初始化连接池
     * @param initialSize 初始连接数量
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialSize<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>initialSize<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                pool<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">ConnectionDriver</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放连接
     * @param connection 待释放的连接
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseConnection</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//回收后插到队尾</span>
                pool<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//释放后通知因为没有连接而阻塞的线程</span>
                pool<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取连接
     * @param millis 超时时间
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">fetchConnection</span><span class="token punctuation">(</span><span class="token keyword">long</span> millis<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//初始 millis&lt;0 时，表示不超时一直等</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>millis<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    pool<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//计算超时时刻</span>
                <span class="token keyword">long</span> future<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>millis<span class="token punctuation">;</span>
                <span class="token keyword">long</span> remaining<span class="token operator">=</span>millis<span class="token punctuation">;</span>
                <span class="token comment">//超时等待</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>remaining<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    pool<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    remaining<span class="token operator">=</span>future<span class="token operator">-</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//返回结果。若超时后队列仍然为空，则返回null</span>
                <span class="token class-name">Connection</span> result<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    result<span class="token operator">=</span>pool<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//用一个动态代理类代理Connection，在commit时进行 100 ms 休眠</span>
<span class="token keyword">class</span> <span class="token class-name">ConnectionDriver</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token comment">//代理commit方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ConnectionDriver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ConnectionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>线程池技术</strong></p> <ul><li><p>线程的创建和销毁都需要消耗系统资源，若服务端的程序每接到一个任务就创建一个线程处理，将会导致操作系统进行频繁的线程上下文切换，增加系统负载</p></li> <li><p>线程池技术预先创建了若干数量的线程并进行复用。消除了频繁创建销毁线程带来的资源消耗</p></li> <li><p>简单的线程池接口定义：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//线程池接口定义</span>
<span class="token keyword">interface</span> <span class="token class-name">ThreadPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Job</span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token comment">//执行一个Job</span>
    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Job</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//关闭线程池</span>
    <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//增加工作者线程</span>
    <span class="token keyword">void</span> <span class="token function">addWorkers</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//减少工作者线程</span>
    <span class="token keyword">void</span> <span class="token function">removeWorker</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到正在执行的任务数量</span>
    <span class="token keyword">int</span> <span class="token function">getJobSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>线程池接口的一种实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 线程池的一种实现方案。其中，Worker是线程池中预先创建的执行任务的线程，当有Job提交时，交给工作线程执行
 */</span>
<span class="token keyword">class</span> <span class="token class-name">DefaultThreadPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Job</span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ThreadPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Job</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token comment">//最大容量</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_WORKER_NUMS</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">//默认容量</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_WORKER_NUMS</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">//最小容量</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MIN_WORKER_NUMS</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//任务列表</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Job</span><span class="token punctuation">&gt;</span></span> jobs<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//工作者列表</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Worker</span><span class="token punctuation">&gt;</span></span> workers<span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//工作者线程数</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> workerNum<span class="token operator">=</span><span class="token constant">DEFAULT_WORKER_NUMS</span><span class="token punctuation">;</span>
    <span class="token comment">//线程编号</span>
    <span class="token class-name">AtomicLong</span> threadNum<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//无参构造</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">initializeWorkers</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_WORKER_NUMS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//指定初始容量构造</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
        workerNum<span class="token operator">=</span>num<span class="token operator">&gt;</span><span class="token constant">MAX_WORKER_NUMS</span><span class="token operator">?</span><span class="token constant">MAX_WORKER_NUMS</span><span class="token operator">:</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token constant">MIN_WORKER_NUMS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initializeWorkers</span><span class="token punctuation">(</span>workerNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//初始化工作者</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializeWorkers</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Worker</span> worker<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> thread<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span><span class="token string">&quot;Thread-pool-worker-&quot;</span><span class="token operator">+</span>threadNum<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//提交并执行一个任务</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Job</span> job<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//添加一个任务并通知等待任务的工作者线程</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">{</span>
                jobs<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
                jobs<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//关闭线程池</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Worker</span> worker<span class="token operator">:</span>workers<span class="token punctuation">)</span><span class="token punctuation">{</span>
            worker<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//添加一个工作者线程</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addWorkers</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//检查是否超过最大线程池数量</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>num<span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>workerNum<span class="token operator">&gt;</span><span class="token constant">MAX_WORKER_NUMS</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                num<span class="token operator">=</span><span class="token constant">MAX_WORKER_NUMS</span><span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>workerNum<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">initializeWorkers</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>workerNum<span class="token operator">+=</span>num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//删除一个工作者线程</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeWorker</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>num<span class="token operator">&gt;=</span><span class="token keyword">this</span><span class="token punctuation">.</span>workerNum<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;超过现有数量！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">&lt;</span>num<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Worker</span> worker<span class="token operator">=</span>workers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//尝试删除，若成功进行停止操作并 计数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    worker<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>workerNum<span class="token operator">-=</span>count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取当前线程池任务量</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getJobSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jobs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//内部类，工作者线程定义</span>
    <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token comment">//正在工作？</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> running<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Job</span> job<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//任务列表是空时等待</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            jobs<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//被打断进行中断返回</span>
                            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//得到一个任务</span>
                    job<span class="token operator">=</span>jobs<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//执行任务</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    job<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//关闭Worker</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            running<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>上述代码中，Worker是线程池中预先创建好的可以复用的线程，Job是客户端提供的实现了Runnable接口的任务。当向线程池提交(execute())一个任务时，线程池会复用Worker线程去执行该任务</p></li></ul></li> <li><p><strong>基于线程池的简单Web服务器</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 利用线程池实现的简单Web服务器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleHttpServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleHttpServer</span><span class="token punctuation">.</span><span class="token function">setBasePath</span><span class="token punctuation">(</span><span class="token string">&quot;E:/Desktop/study/java/jvmlearn/src/resources/server-root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SimpleHttpServer</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//线程池</span>
    <span class="token keyword">static</span> <span class="token class-name">ThreadPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpRequestHandler</span><span class="token punctuation">&gt;</span></span> threadPool<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultThreadPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Http服务器路径</span>
    <span class="token keyword">static</span> <span class="token class-name">String</span> basePath<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">ServerSocket</span> serverSocket<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setPort</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token class-name">SimpleHttpServer</span><span class="token punctuation">.</span>port<span class="token operator">=</span>port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setBasePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePath<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>basePath<span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>basePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token class-name">SimpleHttpServer</span><span class="token punctuation">.</span>basePath<span class="token operator">=</span>basePath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//开启端口监听</span>
        serverSocket<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Socket</span> socket<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//收到请求后用连线程池处理</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>socket<span class="token operator">=</span>serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到一个请求：&quot;</span><span class="token operator">+</span>socket<span class="token punctuation">.</span><span class="token function">getInetAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpRequestHandler</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        serverSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Http请求处理线程</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HttpRequestHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">HttpRequestHandler</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token operator">=</span>socket<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> line<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">BufferedReader</span> reader<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">BufferedReader</span> br<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">PrintWriter</span> writer<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">InputStream</span> inputStream<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//解析请求内容</span>
                reader<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> header<span class="token operator">=</span>reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//解析HTTP报文提取请求路径</span>
                <span class="token class-name">String</span> filePath<span class="token operator">=</span>basePath<span class="token operator">+</span>header<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                writer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//相应图片请求</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filePath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;jpg&quot;</span><span class="token punctuation">)</span><span class="token operator">||</span>filePath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    inputStream<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token operator">=</span>inputStream<span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//响应体</span>
                    <span class="token class-name">OutputStream</span> o<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK\n&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Server: XIAO\n&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type: image/jpeg\n&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Length: &quot;</span><span class="token operator">+</span>bytes<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    o<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//相应html文件请求</span>
                    br<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Server: XIAO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type: text/html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token operator">=</span>br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//刷新输出</span>
                writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>writer<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 500&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">//关闭资源</span>
                <span class="token function">close</span><span class="token punctuation">(</span>br<span class="token punctuation">,</span>inputStream<span class="token punctuation">,</span>writer<span class="token punctuation">,</span>reader<span class="token punctuation">,</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>closeables<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closeables<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Closeable</span> toClose<span class="token operator">:</span>closeables<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>toClose<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                            toClose<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="java中的锁"><a href="#java中的锁" class="header-anchor">#</a> Java中的锁</h2> <h3 id="lock接口"><a href="#lock接口" class="header-anchor">#</a> Lock接口</h3> <ul><li><p>JavaSE5之后，并发包中新增Lock接口用于实现锁功能</p></li> <li><p>Lock接口提供了与<code>synchronized</code>关键字的异同：</p> <ul><li>Lock锁需要显式地获取和释放，synchronized会隐式获取和释放</li> <li>Lock锁提供了比synchronized更强地功能，如尝试非阻塞获取锁、可被中断地获取锁、超时获取锁等</li></ul></li> <li><p>基本使用方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//实例化一个锁对象</span>
<span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取锁 应该避免在 try 块中获取，因为可能未获取到却在 finally 中释放</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
    <span class="token comment">//确保在finally中释放锁</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Lock较synchronized提供的新特性：</p> <ol><li><strong>尝试非阻塞地获取锁</strong>：线程尝试获取锁，若成功，则持有锁并返回true，失败返回false。不会因为等待锁而阻塞</li> <li><strong>能被中断地获取锁</strong>：获取到锁的线程可以响应中断，响应中断后会抛出中断异常并释放锁</li> <li><strong>超时获取锁</strong>：设置一个超时时间，若在此期间内没有获得锁将直接返回，不继续阻塞等待</li></ol></li> <li><p>Lock的基本API：</p> <ul><li><code>void lock()</code> <ul><li>阻塞式获取锁，成功获取锁后才返回</li></ul></li> <li><code>void lockInterruptibly()throws InterruptedException</code> <ul><li>可中断地获取锁，此方法可响应中断，即在等待获取锁的时候可被中断</li></ul></li> <li><code>boolean tryLock()</code> <ul><li>尝试非阻塞式获得锁，调用会立即返回，能获得锁返回true并持有，否则返回false</li></ul></li> <li><code>boolean tryLock(long time,TimeUnit unit) throws InterruptedException</code> <ul><li>超时获取锁，在指定时间内还未获取锁则返回false</li></ul></li> <li><code>void unlock()</code> <ul><li>释放锁</li></ul></li> <li><code>Condition newCondition()</code> <ul><li>获取等待/通知组件，返回的Condition对象有可完成<code>wait()</code>和<code>notify()</code>功能的<code>await()</code>和<code>notify()</code>函数</li></ul></li></ul></li></ul> <h3 id="队列同步器-abstractqueuedsynchronizer"><a href="#队列同步器-abstractqueuedsynchronizer" class="header-anchor">#</a> 队列同步器(AbstractQueuedSynchronizer)</h3> <ul><li>队列同步器时用于<strong>构建锁</strong>或其他<strong>同步组件</strong>的基础框架（如基于同步器可实现ReentrantLock）</li> <li>内部使用一个int成员变量表示<strong>同步状态</strong>，用内置的FIFO队列完成线程的排队工作</li> <li>同步器的主要使用方法：
<ul><li>子类继承同步器并实现其抽象方法来管理同步状态</li> <li>使用<code>getState()</code>、<code>setState(int newState)</code>、<code>compareAndSetState(int expect,int update)</code>来修改状态</li></ul></li> <li>同步器本身没有实现任何同步接口，仅定义了若干同步状态和获取、释放的方法供自定义同步组件使用</li> <li>支持<strong>独占式获取</strong>同步状态和<strong>共享式获取</strong>同步状态</li> <li>同步器是实现锁的关键，通常一个锁内部聚合一个同步器用于实现锁的语义</li></ul> <h3 id="队列同步器的接口"><a href="#队列同步器的接口" class="header-anchor">#</a> 队列同步器的接口</h3> <ul><li><p>队列同步器基于模板方法模式实现</p></li> <li><p>同步器中可重写的方法表：</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>protected boolean tryAcquire(int arg)</td> <td>独占式获取同步状态，实现时需要使用CAS设置同步状态</td></tr> <tr><td>protected boolean tryRelease(int arg)</td> <td>独占式释放同步状态，等待获取同步状态的线程将有机会获取</td></tr> <tr><td>protected int tryAcquireShared(int arg)</td> <td>共享式获取同步状态，返回大于等于0的值表示成功，反之失败</td></tr> <tr><td>protected boolean tryReleaseShared(int arg)</td> <td>共享式释放同步状态</td></tr> <tr><td>protected boolean isHeldExclusively()</td> <td>当前同步器是否在独占模式下被线程占用</td></tr></tbody></table></li> <li><p>实现自定义同步组件(如锁)时，将会调用同步器提供的模板方法：</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>void acquire(int arg)</td> <td>独占式获取同步状态。获取成功则由该方法返回，否则进入同步队列等待，该方法会调用重写的tryAcquire方法</td></tr> <tr><td>void acquireInterruptibly(int arg)</td> <td>同上，但是当进入同步队列等待时可以响应中断抛出中断异常并返回</td></tr> <tr><td>boolean tryAcquireNanos(int arg,long nanos)</td> <td>在上一个方法上增加了超时限制</td></tr> <tr><td>void acquireShared(int arg)</td> <td>共享式获取同步状态，与独占式的区别时同一时刻可以有多个线程获取到同步状态</td></tr> <tr><td>void acquireSharedInterruptibly(int arg)</td> <td>类比独占式</td></tr> <tr><td>boolean tryAcquireSharedNanos(int arg,long nanos)</td> <td>类比独占式</td></tr> <tr><td>boolean release(int arg)</td> <td>独占式释放同步状态，会在释放后将同步队列的第一个线程唤醒</td></tr> <tr><td>boolean releaseShared(int arg)</td> <td>共享式释放</td></tr> <tr><td>Collection&lt;Thread&gt; getQueuedThreads()</td> <td>获取等待在同步队列上的线程集合</td></tr></tbody></table> <blockquote><p>上述的acquire()、release()等方法在实现时其内部实际上是调用可重写的tryAcquire()等方法完成的。因此对于自定义的同步器，只需要重写tryXXX那几个方法即可。</p> <p>而在使用自定义的同步器时，是调用同步器的 acquire()、release()等方法</p></blockquote></li> <li><p><strong>自定义互斥锁示例</strong></p> <ul><li>自定义锁继承自AQS时，主要重写上述第一个表中的5个方法</li> <li>通常自定义同步组件和自定义同步器之间是组合关系。常见的是在实现自定义同步组件时在内部定义一个继承自AQS的静态内部类作为自定义同步器</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//自定义的独占式锁</span>
<span class="token keyword">class</span> <span class="token class-name">Mutex</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">{</span>
    <span class="token comment">//静态内部类，继承自AQS的自定义同步器</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MySync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">{</span>
        <span class="token comment">//是否正被独占</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//尝试获得锁的逻辑</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//CAS比较状态是否是预期，0表示锁未被获取</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//设置拥有独占锁的线程</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//尝试释放锁</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放未被获取的锁时抛出异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//重置锁状态</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConditionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将锁的获取、释放的细节代理给 MySync 完成即可</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MySync</span> mySync<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MySync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//**************** 以下是Lock接口的方法*****************</span>
    <span class="token comment">//获取锁</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mySync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//可中断地获取锁</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        mySync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//尝试获取锁</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mySync<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//超时尝试获取锁</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mySync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//释放锁</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mySync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//条件对象</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mySync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="队列同步器的实现"><a href="#队列同步器的实现" class="header-anchor">#</a> 队列同步器的实现</h3> <ul><li><p><strong>同步队列</strong></p> <ul><li><p>同步器依赖内部的FIFO双向队列来完成同步管理</p></li> <li><p>当线程获取同步状态(如锁)失败时，同步器会将线程及其状态等信息构建成一个<code>Node</code>节点放入同步队列尾部，并会阻塞被该线程</p></li> <li><p>同步队列中Node节点结构：</p> <table><thead><tr><th>属性</th> <th>描述</th></tr></thead> <tbody><tr><td>int waitStatus</td> <td>等待状态。包括CANCELLED、SIGNAL、CONDITION、PROPAGETE、INITIAL</td></tr> <tr><td>Node prev</td> <td>前驱节点</td></tr> <tr><td>Node next</td> <td>后继节点</td></tr> <tr><td>Node nextWaiter</td> <td>等待队列中的后继节点</td></tr> <tr><td>Thread thread</td> <td>相关线程</td></tr></tbody></table></li> <li><p>对于一个同步器，其拥有一个首节点指针和尾节点指针。</p> <p><img src="/juc-pic/%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97%E7%BB%93%E6%9E%84.jpg" alt="image-20210630165816100"></p></li> <li><p>其中**首节点表示成功获取同步状态的节点。**首节点释放同步状态后，会唤醒后继节点，后继节点在获取同步状态成功后会将自己设为新的首节点。</p></li> <li><p>通过<code>setHead()</code>方法设置队首节点；通过<code>compareAndSetTail()</code>设置尾节点。因为头节点的设置仅仅有头节点的下一个节点有机会，所以不用同步。而尾节点有可能多个线程设置，因此使用CAS设置保证正确性</p></li></ul></li> <li><p><strong>独占式同步状态的获取与释放</strong></p> <ul><li><p>通过调用同步器的<code>acquire(int arg)</code>方法可以获取同步状态。此方法<strong>对中断不敏感</strong>，当获取失败进入同步队列后，后续对线程由中断操作也不会导致线程从同步队列移除</p></li> <li><p><code>acquire()</code>源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//获取同步状态</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div></li> <li><p><code>addWaiter()源码</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//将线程添加进同步队列，参数指定是独占式EXCLUSIVE还是共享式SHARED</span>
<span class="token keyword">private</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//以当前线程 构建节点</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>currentThread<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//尝试快速在队尾添加节点</span>
    <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pred<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
        <span class="token comment">//使用CAS保证节点安全添加</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">return</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//确保节点被正确添加</span>
    <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>enq()</code>源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//“死循环” 确保节点被正确地添加进队列。  CAS+循环保证原子性</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token comment">//当前同步队列为空时，先确保正确初始化</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                tail<span class="token operator">=</span>head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>prev<span class="token operator">=</span>t<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                t<span class="token punctuation">.</span>next<span class="token operator">=</span>node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>acquireQueued()</code>源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//使得队列中的 node 节点“循环”尝试获取同步状态，获取失败时阻塞</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> failed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> interrupted<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p<span class="token operator">=</span>node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//检查节点的前驱是不是头节点并尝试获取同步状态</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span>head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token comment">//获得同步状态，设置当前节点为头节点</span>
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>next<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//设为null后有助于GC</span>
                failed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                interrupted<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        <span class="token comment">//一直没获得同步状态并且被打断了，此时取消获取操作</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>对于独占式同步状态的释放，调用<code>release()</code>即可，在同步状态释放后，会通知释放节点的后继节点，以便其能尝试获得同步状态。源码如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h<span class="token operator">=</span>head<span class="token punctuation">;</span>
        <span class="token comment">//若头节点非空且不是初始状态</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒后继。使用LockSupport</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p><strong>共享式同步状态获取与释放</strong></p> <ul><li><p>共享式获取与独占式获取主要区别是<strong>同一时刻能否有多个线程获取</strong>到同步状态</p></li> <li><p>如文件的读写。任何时刻写都应该是独占式的，但是对于读，却可以允许多个读同时进行</p></li> <li><p>通过<code>acquireShared()</code>可以共享式地获取同步状态，源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//当返回值小于 0 时，表示资源(同步状态)已经使用完，需要进入队列等待</span>
        <span class="token function">doAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token operator">=</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构建共享式队列节点并加入队列</span>
    <span class="token keyword">boolean</span> failed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> interrupted<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p<span class="token operator">=</span>node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//检查前驱是否是头节点</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span>head<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//尝试获取共享状态</span>
                <span class="token keyword">int</span> r<span class="token operator">=</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//若还有“资源”</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//设置为头节点，表示获取到同步状态</span>
                    <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    p<span class="token punctuation">.</span>next<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
                        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    failed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//判断是否退出“自旋”，进行阻塞</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                interrupt<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>通过<code>releaseShared()</code>进行共享式同步状态的释放</p></li> <li><p>其中，不同于独占式，共享式在释放时必须保证资源数(同步状态)正确地得到更新，一般通过循环CAS保证</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//如果尝试释放成功</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//进行释放</span>
        <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p><strong>独占式超时获取同步状态</strong></p> <ul><li><p>通过<code>doAcquireNanos()</code>可以超时获取同步状态</p></li> <li><p>响应中断的同步状态获取过程：Java5前，线程获取不到锁被阻塞时，对该线程进行中断，此时虽然会修改中断标志，但线程依旧阻塞等待获取锁。而Java5中，同步器提供了<code>acquireInterruptibly()</code>，在等待获取同步状态时，当前线程可以被中断返回</p></li> <li><p>超时获取同步状态可看作中断获取同步的修改版，在中断获取的基础上加了超时</p></li> <li><p><code>doAcquireNanos()</code>源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">doAcquireNanos</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">,</span><span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
    <span class="token keyword">long</span> lastTime<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token operator">=</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> failed<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p<span class="token operator">=</span>node<span class="token punctuation">.</span><span class="token function">redecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//检查前驱是否是头节点并尝试获取同步状态</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span>head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>next<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
                failed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ture<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//判断是否超时，超时直接返回</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>nanosTimeout<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//是否阻塞等待，当nanosTimeout小于等于spinForTimeoutThreshold(100ns)时，线程进入快速自旋而不是</span>
            <span class="token comment">//超时等待。因为非常短的超时等待是难以做到很精确的</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nanosTimeout<span class="token operator">&gt;</span>spinForTimeoutThreshold<span class="token punctuation">)</span>
                <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>nanosTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新超时时间</span>
            <span class="token keyword">long</span> now<span class="token operator">=</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            nanosTimeout<span class="token operator">-=</span>now<span class="token operator">-</span>lastTime<span class="token punctuation">;</span>
            lastTime<span class="token operator">=</span>now<span class="token punctuation">;</span>
            <span class="token comment">//响应中断</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h3 id="队列同步器使用实例-twinslock"><a href="#队列同步器使用实例-twinslock" class="header-anchor">#</a> 队列同步器使用实例——TwinsLock</h3> <ul><li><p>TwinsLock是一个同一时刻至多允许两个线程同时访问，超过两个线程是进行阻塞等待的锁</p></li> <li><p>分析：</p> <ul><li>同一时刻支持两个及以上线程，因此是<strong>共享式</strong>的</li> <li>至多允许两个线程同时访问，可定义资源数为2，可取0 1 2三种状态，为0时表示资源已经用完，需要阻塞</li></ul></li> <li><p>实现代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">TwinsLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">{</span>
    <span class="token comment">//组合一个AQS</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">{</span>
        <span class="token comment">//初始化资源数</span>
        <span class="token keyword">public</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialResourceNum<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>initialResourceNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//重写获取和释放资源的方法</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取一次锁应该将资源数减一</span>
            <span class="token comment">//循环CAS保证资源获取的正确计数</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">int</span> current<span class="token operator">=</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> newNum<span class="token operator">=</span>current<span class="token operator">-</span>arg<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newNum<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">||</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>newNum<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> newNum<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//类似获取，用循环CAS保证释放后资源计数的正确性</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">int</span> current<span class="token operator">=</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> newNum<span class="token operator">=</span>current<span class="token operator">+</span>arg<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>newNum<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConditionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//创建代理对象</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireSharedNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="重入锁"><a href="#重入锁" class="header-anchor">#</a> 重入锁</h3> <ul><li><p>重入锁(ReentrantLock)即支持同一线程重复获取的锁</p></li> <li><p>重入锁解决了持有锁的线程再次尝试获得该锁时可能造成自己阻塞自己的情况</p></li> <li><p>ReentrantLock支持公平锁和非公平锁的选择，在构造函数中指定。默认是非公平的</p></li> <li><p>公平锁即在获取锁时，先请求的线程先获得锁，也即按照同步队列中的顺序依次获得锁。而非公平锁则是多个线程同时尝试CAS获取锁，成功的线程获得锁</p></li> <li><p>非公平锁的效率往往比公平锁高，且可提供更大的吞吐量。因为<strong>公平锁需要进行大量的线程上下文切换</strong>。</p></li> <li><p>公平锁的优点是可以减少“饥饿”现象</p></li> <li><p><code>synchronized</code>关键字提供的锁机制是可重入的</p></li> <li><p>基本实现思想：</p> <ul><li>在获取锁的时候，判断获取锁的线程是否时当前持有锁的线程</li> <li>若是，则对<strong>同步状态进行+1计数</strong>，表示再次获得锁</li> <li>若不是，放入同步队列进行阻塞等待</li> <li>在锁的释放的时候，<strong>对同步状态进行-1</strong>，当同步状态减为0时表示锁已经释放</li></ul></li> <li><p><code>ReentrantLock</code>的<code>nofairTryAcquire()</code>源码——非公平锁可重入锁获取</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//同步状态为 0 表示当前锁未被获取，各个线程谁用CAS操作成功则获得锁，因此是非公平的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取锁的是当前持有锁的线程</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//计算下一个同步状态值</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新同步状态值</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>ReentrantLock</code>的<code>tryRelease()</code>源码——释放锁</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//计算释放后的同步状态值</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//若释放后的同步状态值为 0 表示该锁已经完全释放，返回true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//锁没有完全释放返回false</span>
    <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>ReentrantLock</code>的<code>tryAcquire()</code>源码——公平可重入锁获取</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//相对于非公平锁，公平锁多加了一个判断当前欲获取锁的节点是否有前驱的条件</span>
        <span class="token comment">//没有前驱的节点为同步队列中的队首节点，按照FIFO原则，若公平，</span>
        <span class="token comment">//则只有该节点有机会获取锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="读写锁"><a href="#读写锁" class="header-anchor">#</a> 读写锁</h3> <ul><li><p>读写锁在同一时刻允许多个读线程访问，但是写线程访问时所有读和其他写均被阻塞</p></li> <li><p>在有读锁时线程无法获取写锁，且读锁是共享锁可被多个线程获取，如何避免产生“写饥饿”？</p> <ul><li>在获取读锁时，检查当前是否有尝试获取写锁的线程在排队，若有则应该阻塞而不是立即获取读锁</li></ul></li> <li><p>读写锁分离有助于提高并发性能，特别适用于读多写少的场景，提供更好的并发性和吞吐量</p></li> <li><p>JUC中提供的读写锁实现是<code>ReentrantReadWriteLock</code>，具有三个特性</p> <ul><li>可选是否公平锁</li> <li>支持锁重入</li> <li>支持锁降级：遵循获取写锁、获取读锁、释放写锁的次序可使<strong>写锁(独占锁)降级为读锁(共享锁)</strong></li></ul></li> <li><p><code>ReadWriteLock</code>接口仅定义了<code>readLock()</code>和<code>writeLock()</code>方法用于获取读、写锁。<code>ReentrantReadWriteLock</code>提供了其他方法：</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>int getReadLockCount()</td> <td>返回读锁总共被获取的次数</td></tr> <tr><td>int getReadHoldCount()</td> <td>返回当前线程获取读锁的次数，使用ThreadLocal</td></tr> <tr><td>boolean isWriteLocked()</td> <td>写锁是否被获取</td></tr> <tr><td>int getWriteHoldCount()</td> <td>当前写锁被获取的次数</td></tr></tbody></table></li> <li><p><strong>读写锁实现的缓存(Cache)示例</strong>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//使用读写锁实现的一个线程安全的缓存</span>
<span class="token keyword">class</span> <span class="token class-name">Cache</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//读写锁</span>
    <span class="token keyword">static</span> <span class="token class-name">ReentrantReadWriteLock</span> readWriteLock<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//需要“分离”读写锁</span>
    <span class="token keyword">static</span> <span class="token class-name">Lock</span> readLock<span class="token operator">=</span>readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Lock</span> writeLock<span class="token operator">=</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取读锁</span>
        readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放读锁</span>
            readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取写锁</span>
        writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放写锁</span>
            writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="读写锁的实现"><a href="#读写锁的实现" class="header-anchor">#</a> 读写锁的实现</h3> <ul><li><p>读写锁也依赖于自定义同步器实现，读写状态即同步器的同步状态</p></li> <li><p>仅用一个int变量就要表示多种状态，可以使用“按位切割”的方式用不同位表示不同状态</p></li> <li><p>读写锁将int型变量(32位)，切割成<strong>高16位表示读，低16位表示写</strong></p></li> <li><p>使用位运算判断读写状态，设同步状态为S：</p> <ul><li>写状态：<strong>S &amp; 0x0000FFFF</strong>，即高16为置零</li> <li>读状态：<strong>S&gt;&gt;&gt;16</strong>，即无符号右移16位（左边补零）</li> <li>写状态增加时，位<strong>S+1</strong>，而读状态增加为<strong>S+(1&lt;&lt;16)</strong></li></ul></li> <li><p>判断<strong>读锁是否被获取</strong>：当<strong>S!=0 &amp;&amp; (S&amp;0x0000FFFF)==0</strong>时表示有读锁被获取</p></li> <li><p><strong>写锁的获取与释放</strong></p> <ul><li>写锁是可重入的排它锁</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//tryAcquire()源码</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取写锁被获取次数</span>
    <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span>
        <span class="token comment">//同步状态不为 0 并且写锁数量为 0 --&gt; 存在读锁，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//写锁获取次数溢出，抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_COUNT</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Reentrant acquire</span>
        <span class="token comment">//否则表示当前线程重入获取写锁</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// c = 0，即当前既没有写锁也没有读锁，CAS尝试获取锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>释放时只需要对写的计数减一，当为 0 表示写锁释放</li></ul></li> <li><p><strong>读锁的获取与释放</strong></p> <ul><li>读锁是支持重入的共享锁。在没有写时，读锁的获取总是成功，只需要安全地增加读状态即可</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//tryAcquireShared()源码</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//有写锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//没有写锁被获取时用CAS获取写锁</span>
    <span class="token comment">//其中readerShoulBlock()方法可以达到防止写饥饿的作用</span>
    <span class="token comment">//即若等待队列中有需要进行优先调度的获取锁的线程(如需要获取写锁的)，则当前线程应该等待</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        r <span class="token operator">&lt;</span> <span class="token constant">MAX_COUNT</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> <span class="token constant">SHARED_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>
            firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                cachedHoldCounter <span class="token operator">=</span> rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>读锁的释放也只需要保证线程安全的计数较少即可，每次减少<strong>1&lt;&lt;16</strong></li></ul></li> <li><p><strong>锁降级</strong></p> <ul><li><p>指写锁降级为读锁。在当前持有写锁的情况下，再获取读锁，随后释放写锁的过程</p></li> <li><p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//多个线程可以并发处理数据，当数据变更后，若当前线程感知到数据变化则进行数据处理流程</span>
<span class="token comment">//同时其他线程被阻塞，直到当前线程完成数据的处理工作</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//先释放之前的读锁</span>
        readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取写锁</span>
        writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//数据处理流程</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                update<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//持有写锁的情况下获取读锁</span>
            readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
            <span class="token comment">//释放写锁完成锁降级</span>
            writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//降级完成，写锁------&gt;读锁</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">//使用数据流程</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>持有写锁后获取读锁的必要性：假设直接释放写锁而不获取读锁，则可能在释放写锁后另一个线程获取写锁并修改了数据，此时会造成写锁释放之后的代码(上述20行以后)读到的数据是不准确的，即另一个线程修改数据对当前线程不可见</p></li></ul></li></ul> <h3 id="locksupport工具"><a href="#locksupport工具" class="header-anchor">#</a> LockSupport工具</h3> <ul><li><p><code>LockSupport</code>定义了一组公共静态方法，提供了最基本的<strong>线程阻塞</strong>和<strong>唤醒</strong>功能</p></li> <li><p>提供的方法：</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>void park()</td> <td>阻塞当前线程。调用unpark(thread)或被中断时从park()返回</td></tr> <tr><td>void park(Object blocker)</td> <td>参数blocker为标识当前线程阻塞的对象</td></tr> <tr><td>void parkNanos( long nanos)</td> <td>park上增加超时</td></tr> <tr><td>void parkNanos(Object blocker , long nanos)</td> <td>....</td></tr> <tr><td>void parkUntil(long deadline)</td> <td>类似超时，按时刻算，直到以1970开始的毫秒数deadline</td></tr> <tr><td>void parkUntil(Object blocker , long deadline)</td> <td>....</td></tr> <tr><td>void unpark(Thread thread)</td> <td>唤醒thread线程</td></tr></tbody></table></li></ul> <h3 id="condition接口"><a href="#condition接口" class="header-anchor">#</a> Condition接口</h3> <ul><li><p>Condition接口提供了类似<code>wait()</code>、<code>notify()</code>等方法，用于配合Lock接口实现<strong>等待/通知机制</strong></p></li> <li><p>较普通的<code>wait()</code>等方法，Condition接口有如下特点</p> <ul><li>有多个等待队列数</li> <li>支持等待状态不响应中断</li> <li>支持Until等待</li></ul></li> <li><p>Condition定义了等待/通知两种类型的方法，调用这些方法需要提前获取到Condition对象关联的锁</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Lock</span> lock<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//需要调用 Lock 的newCondition 获取与锁关联的Condition对象</span>
<span class="token class-name">Condition</span> condition<span class="token operator">=</span>lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">conditionWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
    <span class="token comment">//需要获取锁后才能使用</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">//等待</span>
        condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">conditionSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">//通知</span>
        condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="condition的实现"><a href="#condition的实现" class="header-anchor">#</a> Condition的实现</h3> <ul><li><p><code>ConditionObject</code>事同步器<code>AbstractQueuedSynchronizer</code>的内部类，每个Condition包含一个队列(等待队列)</p></li> <li><p><strong>等待队列</strong></p> <ul><li>Condition的等待队列类似于AQS的同步队列。在调用<code>await()</code>方法后，线程将会释放锁并构造成节点加入等待队列进行等待</li> <li>Condition拥有指向首节点和尾节点的指针，每次await()调用后从尾部加入</li> <li>新增节点只需要将原有尾节点的next指向该节点，并更新尾节点即可。此过程并不需要CAS，因为调用await()的线程必定已经获取了锁</li> <li>一个Lock可以有多个Condition，因此，就有多个等待队列</li></ul></li> <li><p><strong>等待</strong></p> <ul><li><p>从队列的角度看，调用await相当于同步队列的首节点移动到等待队列中</p></li> <li><p><code>await()</code>源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将当前线程构造成节点加入等待队列</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addConditionWaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//释放锁</span>
    <span class="token keyword">int</span> savedState <span class="token operator">=</span> <span class="token function">fullyRelease</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> interruptMode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//当前节点不在同步队列中</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isOnSyncQueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interruptMode <span class="token operator">=</span> <span class="token function">checkInterruptWhileWaiting</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">acquireQueued</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> savedState<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> interruptMode <span class="token operator">!=</span> <span class="token constant">THROW_IE</span><span class="token punctuation">)</span>
        interruptMode <span class="token operator">=</span> <span class="token constant">REINTERRUPT</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nextWaiter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// clean up if cancelled</span>
        <span class="token function">unlinkCancelledWaiters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptMode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">reportInterruptAfterWait</span><span class="token punctuation">(</span>interruptMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p><strong>通知</strong></p> <ul><li><p>调用<code>signal()</code>方法，会唤醒在等待队列中等待时间最长的节点(首节点)</p></li> <li><p>过程为：将等待队列的首节点移动到同步队列，然后使用LockSupport工具唤醒线程</p></li> <li><p>对应的<code>signalAll()</code>会将所有的等待队列节点移动到同步队列中</p></li> <li><p><code>signal()</code>源码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//先检查是否持有锁——必须要持有锁才能使用signal()</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span> first <span class="token operator">=</span> firstWaiter<span class="token punctuation">;</span>
    <span class="token comment">//取等待队列中的第一个节点进行唤醒</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token function">doSignal</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h2 id="java并发容器与框架"><a href="#java并发容器与框架" class="header-anchor">#</a> Java并发容器与框架</h2> <h3 id="concurrenthashmap"><a href="#concurrenthashmap" class="header-anchor">#</a> ConcurrentHashMap</h3> <ul><li>ConcurrentHashMap是并发安全且高效的HashMap</li></ul> <h4 id="为何使用"><a href="#为何使用" class="header-anchor">#</a> 为何使用？</h4> <ul><li>在并发编程中，使用<code>HashMap</code>进行<code>put()</code>操作可能<strong>引起死循环</strong>，因为多线程的操作导致HashMap的Entry链表形成环形数据结构，导致<code>put()</code>时next节点一直不为空，从而无法新加入节点</li> <li><code>HashTable</code>的效率比较低。其使用<code>synchronized</code>来保证线程安全，在竞争较激烈的情况下效率很低，如两个线程都执行<code>put()</code>，彼此之间都需要阻塞</li> <li><code>ConcurrentHashMap</code>使用分段锁技术，可以有效地提高并发访问效率。分段锁思想是将HashMap分为多个段，分别对每个段的访问进行加锁，段之间不影响</li></ul> <h4 id="concurrenthashmap的操作"><a href="#concurrenthashmap的操作" class="header-anchor">#</a> ConcurrentHashMap的操作</h4> <ul><li><code>get()</code> <ul><li>get是一个不需要加锁就能进行的操作，因此十分高效，当get读到的值为空时，才进行加锁重读</li> <li>get方法中要使用的共享变量都是定义为<code>volatile</code>类型的，因此可以保证可见性，get中只读不写共享变量，所以不需要加锁</li></ul></li> <li><code>put()</code> <ul><li>put方法中因为涉及到共享变量的写操作，因此必须加锁进行</li> <li>put方法要检查是否需要扩容，若需要则进行扩容</li></ul></li></ul> <h3 id="concurrentlinkedqueue"><a href="#concurrentlinkedqueue" class="header-anchor">#</a> ConcurrentLinkedQueue</h3> <ul><li>ConcurrentLinkedQueue是一个基于链接节点的无界线程安全队列，采用了<code>wait-free</code>即CAS来实现</li></ul> <h3 id="java中的阻塞队列"><a href="#java中的阻塞队列" class="header-anchor">#</a> Java中的阻塞队列</h3> <ul><li><p>基于Java7</p></li> <li><p>阻塞队列即支持一下两个额外操作的队列：</p> <ul><li>支持阻塞的插入方法：当队列满时，插入操作会被阻塞知道队列有多余的位置空出</li> <li>支持阻塞的移除方法：当队列空时，移除操作会被阻塞知道队列中有元素</li></ul></li> <li><p>常用于生产者-消费者场景</p></li> <li><p>4种处理方式</p> <table><thead><tr><th>方法</th> <th>抛出异常</th> <th>返回特殊值</th> <th>一直阻塞</th> <th>超时退出</th></tr></thead> <tbody><tr><td>插入</td> <td>add(e)</td> <td>offer(e)</td> <td>put(e)</td> <td>offer(e,time,unit)</td></tr> <tr><td>移除</td> <td>remove()</td> <td>poll()</td> <td>take()</td> <td>poll(time,unit)</td></tr> <tr><td>检查</td> <td>element()</td> <td>peek()</td> <td>无</td> <td>无</td></tr></tbody></table></li> <li><p>使用无界阻塞队列时，offer永远返回true，put不会阻塞</p></li> <li><p>Java中的阻塞队列</p> <ul><li><code>ArrayBlockingQueue</code>：由数组结构组成的<strong>有界</strong>阻塞队列</li> <li><code>LinkedBlockingQueue</code>：由链表结构组成的<strong>有界</strong>阻塞队列</li> <li><code>PriorityBlockingQueue</code>：支持<strong>优先级排序</strong>的<strong>无界</strong>阻塞队列
<ul><li>默认情况下元素采取自然顺序升序排列，也可以自定义类实现<code>compareTo()</code>方法来指定元素排序，或在初始化队列时指定构造参数<code>Compator</code></li></ul></li> <li><code>DelayQueue</code>：使用优先级队列实现的<strong>无界</strong>阻塞队列
<ul><li>支持延时获取元素。使用PriorityQueue实现。队列中的元素必须实现<code>Delayed</code>接口，在创建元素时可指定多久才能获取队列中的当前元素</li> <li>常用场景：
<ul><li>缓存系统设计：保存元素的缓存有效时间，用一个线程查询DelayQueue，当获取到某个元素时表示该元素已经过期</li> <li>定时任务调度，如<code>TimerQueue</code>就是用<code>DelayQueue</code>实现</li></ul></li></ul></li> <li><code>SynchronousQueue</code>：不存储元素的阻塞队列
<ul><li>每个<code>put()</code>操作必须等待一个<code>take()</code>操作，否则不能继续添加元素</li> <li>常用于传递性场景，如将生产者的数据传递给消费者</li></ul></li> <li><code>LinkedTransferQueue</code>：由链表结构组成的<strong>无界</strong>阻塞队列
<ul><li>多了<code>tryTransfer()</code>和<code>transfer()</code>方法</li> <li>transfer：若当前有消费者正在等待接收元素，transfer可以把生产者传入的元素立即转给消费者，若没有消费者在等待，则将元素放在队列的tail节点，等到该元素被消费后才返回</li> <li>tryTransfer：用于试探生产者传入的元素是否能直接传递给消费者，没有消费者在等待则返回false，不同于transfer，该方法会立即返回而不等到元素被消费</li></ul></li> <li><code>LinkedBlockingDeque</code>：由链表结构组成的<strong>双向</strong>阻塞队列
<ul><li>支持双向插入和移除，因此在多线程环境下可以减少一半的竞争</li></ul></li></ul></li> <li><p>实现原理：使用<strong>等待/通知模式</strong>实现，如ArrayBlockingQueue使用Condition的<code>await()</code>和<code>signal()</code>实现</p></li></ul> <h3 id="fork-join框架"><a href="#fork-join框架" class="header-anchor">#</a> Fork/Join框架</h3> <ul><li><p>Java7提供的一个用于并行执行任务的框架。其主要完成把一个大任务分割成若干小任务，最终汇总小任务结果后得到大任务结果</p></li> <li><p>类似于分治算法，大化小，合并小的结果得到大的结果</p></li> <li><p>Fork理解为分支，即大化小；Join理解为合并，即由小得大</p></li> <li><p><strong>工作窃取算法</strong></p> <ul><li>为了将大任务化为互不依赖得小任务且避免多线程之间的竞争执行，可将小任务放到不同的队列中，而每个队列有一个专门的线程来执行该队列中的任务</li> <li>工作窃取算法是为了减少执行完任务的线程“空等着无事可干”的情况，即当A线程执行完其负责的队列里的任务后，去B负责的队列帮忙执行任务</li> <li>为了避免A与B的竞争，通常使用<strong>双端队列</strong>，约定被窃取的线程从队首拿任务，而窃取者从队尾拿任务</li></ul></li> <li><p><strong>Fork/Join框架的设计</strong></p> <ul><li>两步骤：分割任务+执行任务合并结果</li> <li>两个关键类：
<ul><li><code>ForkJoinTask</code>：使用ForkJoin框架必须先创建一个ForkJoin任务，其提供了在任务中执行<code>fork()</code>和<code>join()</code>的机制。通常任务继承自两个子类：
<ul><li><code>RecursiveAction</code>：用于无返回结果的任务</li> <li><code>RecursiveTask</code>：用于有返回结果的任务</li></ul></li> <li><code>ForkJoinPool</code>：ForkJoin任务需要通过此线程池执行</li></ul></li></ul></li> <li><p><strong>使用示例</strong></p> <ul><li>计算[a,b]区间的和</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//继承自RecursiveTask，因为需要返回结果</span>
<span class="token keyword">class</span> <span class="token class-name">CountTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token comment">//阈值。决定多大规模的任务需要拆解成更小的任务</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THRESHOLD</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token comment">//区间端点</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span><span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token operator">=</span>start<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>end<span class="token operator">=</span>end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//重写特定的计算方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//任务足够小的情况下直接累加进行计算</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>end<span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token operator">&lt;=</span><span class="token constant">THRESHOLD</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> i<span class="token operator">=</span>start<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;=</span>end<span class="token punctuation">)</span>
                sum<span class="token operator">+=</span>i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//任务规模大于阈值时进行拆分</span>
            <span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>start<span class="token operator">+</span>end<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token comment">//拆分成两段计算，即分治思想</span>
            <span class="token class-name">CountTask</span> task1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CountTask</span> task2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CountTask</span><span class="token punctuation">(</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//放到当前线程运行的线程池中执行任务</span>
            task1<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            task2<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//等待返回结果</span>
            <span class="token keyword">int</span> result1 <span class="token operator">=</span> task1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> result2 <span class="token operator">=</span> task2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//整合子任务的结果</span>
            sum<span class="token operator">+=</span>result1<span class="token operator">+</span>result2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>异常处理</strong></p> <ul><li>ForkJoinTask提供了<code>isCompletedAbnormally()</code>方法检查是否已经抛出异常或任务被取消</li> <li>同时提供<code>geetException</code>获取异常</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">isCompletedAbnormally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>实现原理</strong></p> <ul><li>ForkJoinPool由以下两部分组成
<ul><li><code>ForkJoinTask</code>数组：负责将存放的任务交给ForkJoinPool</li> <li><code>ForkJoinWokerThread</code>数组：负责执行任务</li></ul></li> <li>ForkJoinTask的<code>fork()</code>方法
<ul><li>调用fork方法是，程序会调用ForkJoinWorkerThread的<code>pushTask()</code>方法异步执行该任务然后立即返回结果.</li></ul></li> <li>ForkJoinTask的<code>join()</code>方法
<ul><li>join方法的主要作用是阻塞当前线程并等待获取结果</li></ul></li></ul></li></ul> <h2 id="java中的12个原子操作类"><a href="#java中的12个原子操作类" class="header-anchor">#</a> Java中的12个原子操作类</h2> <ul><li>从JDK1.5开始，提供了<code>java.util.concurrent.atomic</code>包，该包中的原子类提供了一种简单高效的线程安全地更新<strong>单个</strong>变量的方式</li> <li>包括对四种类型的原子更新方式：
<ul><li>基本类型</li> <li>数组</li> <li>引用</li> <li>属性（字段）</li></ul></li> <li>Atomic包中的类基本都是使用<code>Unsafe</code>实现的包装类</li></ul> <h3 id="原子更新基本类型"><a href="#原子更新基本类型" class="header-anchor">#</a> 原子更新基本类型</h3> <ul><li><p>包含</p> <ul><li><code>AtomicBoolean</code></li> <li><code>AtomicInteger</code></li> <li><code>AtomicLong</code></li></ul></li> <li><p>以AtomicInteger为例，主要包含以下方法：</p> <table><thead><tr><th>方法</th> <th>描述</th></tr></thead> <tbody><tr><td>int addAndGet(int delta)</td> <td>将原来的值加上一个值，并返回结果</td></tr> <tr><td>boolean compareAndSet(int expect,int update)</td> <td>若输入的值与预期的一样，则用新的值更新旧值</td></tr> <tr><td>int getAndIncrement()</td> <td>自增1，返回的是自增前的结果。看作原子的i++</td></tr> <tr><td>void lazySet(int newValue)</td> <td>懒设置为新值，其他线程可能在短时间内仍能得到旧值</td></tr> <tr><td>int getAndSet(int newValue)</td> <td>设置为新值，并返回旧值</td></tr></tbody></table></li> <li><p>Unsafe中只提供了三种CAS方法：</p> <ul><li><code>compareAndSwapObject()</code></li> <li><code>compareAndSwapInt()</code></li> <li><code>compareAndSwapLong()</code></li></ul></li> <li><p>对于Boolean，其实际上采用将Boolean转换为整型，再使用compareAndSwapInt进行CAS。因此，对于float、double、char类型的变量也可以采用类似思路实现</p></li></ul> <h3 id="原子更新数组"><a href="#原子更新数组" class="header-anchor">#</a> 原子更新数组</h3> <ul><li><p>原子方式更新数组元素包含三个类：</p> <ul><li><code>AtomicIntegerArray</code></li> <li><code>AtomicLongArray</code></li> <li><code>AtomicReferenceArray</code></li></ul></li> <li><p>以AtomicIntegerArray——原子更新整型数组元素为例</p> <ul><li><code>int addAndGet(int index,int delta)</code></li> <li><code>boolean compareAndSet(int index,int expect,int update)</code></li> <li>即多了表示数组下标的参数</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//以参数的形式传入数组</span>
    <span class="token class-name">AtomicIntegerArray</span> aia<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicIntergerArray</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aia<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//.....</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>AtomicXXXArray以参数的形式把数组传入，会得到当前数组的一个副本，进行原子更新操作时<strong>不会影响原来的数组！！！</strong></p></li></ul> <h3 id="原子更新引用类型"><a href="#原子更新引用类型" class="header-anchor">#</a> 原子更新引用类型</h3> <ul><li><p>适用于原子更新多个变量的情况，主要有三个类：</p> <ul><li><code>AtomicReference</code>：原子更新引用类型</li> <li><code>AtomicReferenceFieldUpdater</code>：原子更新引用类型中的字段</li> <li><code>AtomicMarkableReference</code>：原子更新带有标记位的引用类型。可以原子更新一个Boolean类型的标记位和引用类型</li></ul></li> <li><p>以AtomicReference为例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token keyword">int</span> age<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token operator">=</span>name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">=</span>age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> atomicReference<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;uuusss&quot;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> updateUser<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;user2&quot;</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//原子更新引用</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>updateUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="原子更新字段"><a href="#原子更新字段" class="header-anchor">#</a> 原子更新字段</h3> <ul><li><p>当需要更新某个对象中的某个字段时，需要使用相应的原子更新字段类，有如下三个：</p> <ul><li><code>AtomicIntegerFieldUpdater</code>：更新整型字段</li> <li><code>AtomicLongFieldUpdater</code>：更新长整型</li> <li><code>AtomicStampedReference</code>：原子更新带有版本号的引用类型，其将整数值与引用关联起来，可用于原子地更新数据和数据地版本号。解决CAS中的ABA问题</li></ul></li> <li><p>使用原子更新字段的两部：</p> <ul><li>原子更新字段类都是抽象类，每次使用都要用静态方法<code>newUpdater()</code>创建一个更新器，并设置想要更新的类和属性</li> <li>更新类的字段必须要用<code>public volatile</code>修饰</li></ul></li> <li><p>以<code>AtomicIntegerFieldUpdater</code>为例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerFieldUpdaterDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//使用静态方法创建一个更新器，在构造函数中指定类型和需要更新的字段名</span>
        <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> updater<span class="token operator">=</span><span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;User1&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将年龄字段+1 ，返回之前的年龄</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>updater<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回现在的年龄</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>updater<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token comment">//需要更新的字段必须要用 public volatile修饰</span>
        <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="java中的并发工具类"><a href="#java中的并发工具类" class="header-anchor">#</a> Java中的并发工具类</h2> <ul><li>JDK中提供了几个有用的并发工具类，如
<ul><li><code>CountDownLatch</code>、<code>CyclicBarrier</code>、<code>Semaphore</code>等用于控制并发流程</li> <li><code>Exchanger</code>用于提供线程间交换数据的一种手段</li></ul></li></ul> <h3 id="countdownlatch"><a href="#countdownlatch" class="header-anchor">#</a> CountDownLatch</h3> <ul><li><p>CountDownLatch允许一个或者多个线程等待其他线程完成操作</p></li> <li><p>JDK1.5之后的CountDownLatch可以实现类似<code>join()</code>的功能，并且比join更强</p></li> <li><p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建一个CountDownLatch对象，初始化参数为 需要计数的数量</span>
    <span class="token comment">//每次调用 countDown() 方法会将该数 -1 </span>
    <span class="token comment">//当计数为 0 是，唤醒调用 await() 方法的线程继续执行</span>
    <span class="token keyword">static</span> <span class="token class-name">CountDownLatch</span> latch<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;count 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//一次调用，计数 -1</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;count 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//等待计数减为 0 </span>
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CountDown Finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>CountDownLatch在初始化时指定需要计数的大小，每次调用<code>countDown()</code>方法都会将该计数值减去1，直到值为 0 时唤醒调用 <code>await()</code>方法阻塞的线程</p></li> <li><p>常用于一个线程需要等待其他多个线程的某些操作完成后才能继续执行的场景</p></li> <li><p>CountDownLatch<strong>不能重新初始化或者修改其内部的计数器的值</strong></p></li></ul> <h3 id="cyclicbarrier"><a href="#cyclicbarrier" class="header-anchor">#</a> CyclicBarrier</h3> <ul><li><p>即可循环使用的屏障。其主要实现“让一个线程到达一个屏障(同步点)时阻塞，知道最后一个线程到达屏障时屏障才会解除，线程继续执行”</p></li> <li><p><code>CyclicBarrier</code>默认的构造方法有一个构造参数表示屏障拦截的线程数，每个线程调用<code>await()</code>方法执行到屏障并阻塞，当所有线程都到达时，屏障接触线程继续：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CyclicBarrierDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建 CyclicBarrier</span>
    <span class="token keyword">static</span> <span class="token class-name">CyclicBarrier</span> barrier<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 arrived&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//Thread1到达屏障处</span>
                barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Main线程到达屏障</span>
        barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Main Continue....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>CyclicBarrier的另一个高级构造函数：允许在所有线程到达屏障时，优先执行一个BarrierAction，再执行之前阻塞的线程，以处理更复杂的业务场景。<code>CyclicBarrier(int parties,Runnable barrierAction)</code></p></li> <li><p>CyclicBarrier的计数器可以使用<code>reset()</code>方法重置，而CountDownLatch不能</p></li> <li><p>CyclicBarrier还提供了</p> <ul><li><code>getNumberWaiting()</code>用于获得阻塞线程的数量</li> <li><code>isBroken()</code>用于了解阻塞的线程是否被中断等</li></ul></li></ul> <h3 id="semaphore"><a href="#semaphore" class="header-anchor">#</a> Semaphore</h3> <ul><li><p>信号量。用于控制同时访问特定资源的线程数量，通过协调线程保证合理地使用公共资源</p></li> <li><p>Semaphore可用于流量控制，特别是共用资源有限地应用场景，如数据库连接</p></li> <li><p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//线程数</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token comment">//创建线程池</span>
    <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool<span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建Semaphore，构造参数指定最大的并发量，此处一次最多允许10个线程进行</span>
    <span class="token keyword">static</span> <span class="token class-name">Semaphore</span> semaphore<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">THREAD_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//通过 acquire 方法获得”执行许可“</span>
                    semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//睡眠 1 s便于观察输出</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;save data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//使用完后，通过release 方法归还 许可</span>
                    semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Semaphore中的常用方法：</p> <ul><li><code>acquire()</code>：获取许可证</li> <li><code>release()</code>：释放许可证</li> <li><code>tryAcquire()</code>：尝试获得许可证</li> <li><code>int availablePermits()</code>：剩余的许可证数</li> <li><code>int getQueueLength()</code>：正在等待获取许可的线程数</li> <li><code>boolean hasQueueThreads()</code>：是否有线程在等待获得许可</li> <li><code>protected void reducePermits(int reduction)</code>：减少reduction个许可证</li> <li><code>protected Collection getQueuedThreads()</code>：返回所有等待获取许可证的线程集合</li></ul></li></ul> <h3 id="exchanger"><a href="#exchanger" class="header-anchor">#</a> Exchanger</h3> <ul><li><p>用于线程间的数据交换。其提供一个同步点，在此同步点两个线程可以通过<code>exchange()</code>方法交换数据</p></li> <li><p>第一个线程先执行<code>exchange()</code>时，其会一直阻塞等到第二个线程也执行此方法</p></li> <li><p>Exchanger可用于<strong>遗传算法</strong>的筛选后代进行交配的过程。也可以用于<strong>数据校对</strong>工作</p></li> <li><p>一个校对示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExchangerDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//定义Exchanger，泛型类型是需要交换的数据类型</span>
    <span class="token keyword">static</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchanger<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool<span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> <span class="token class-name">A</span><span class="token operator">=</span><span class="token string">&quot;数据A&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//执行到同步点，线程将 A 数据作为交换</span>
                exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> <span class="token class-name">B</span><span class="token operator">=</span><span class="token string">&quot;数据B&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//执行到同步点，线程将 B 数据作为交换，交换得到的数据通过返回值得到</span>
                <span class="token class-name">String</span> <span class="token class-name">A</span><span class="token operator">=</span>exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A、B数据是否一致 ：&quot;</span><span class="token operator">+</span><span class="token class-name">B</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A 为：&quot;</span><span class="token operator">+</span><span class="token class-name">A</span><span class="token operator">+</span><span class="token string">&quot; B为：&quot;</span><span class="token operator">+</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>exchange()</code>的参数是需要交换给对方的值，而返回值是对方交换过来的值</p></li></ul> <h2 id="java中的线程池"><a href="#java中的线程池" class="header-anchor">#</a> Java中的线程池</h2> <ul><li>合理使用线程池的好处：
<ul><li><strong>降低资源消耗</strong>：复用线程池中的线程，避免重复创建和销毁线程的消耗</li> <li><strong>提高响应速度</strong>：任务到达时，不需要等待线程创建就能立即执行</li> <li><strong>提高线程可管理性</strong>：线程池可以进行统一分配、调优和监控</li></ul></li></ul> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <ul><li><p>术语简述：</p> <ul><li><strong>工作线程</strong>：线程池创建线程时，会将线程封装成工作线程Worker，Worker在执行任务后，会循环获取工作队列中的任务来执行</li> <li><strong>工作队列</strong>：新提交到线程池的任务会放在工作队列中等待工作线程获取执行</li> <li><strong>核心线程池</strong>：线程池的基本大小，与此对应的是当队列满且允许的最大线程数没有超过时新创建来执行任务的线程。相比来说核心线程池中的线程即使空闲也不会被终止，其他新创线程会在一定周期内终止</li></ul></li> <li><p>向线程池提交一个任务后的处理流程：</p> <ol><li>判断<strong>核心线程池</strong>中的线程是否都在执行任务，若不是，创建一个新的<strong>工作线程</strong>执行任务，否则下一步</li> <li>判断工作队列是否已满，若没有满，将新提交的任务存储在这个工作队列中，若满了，下一步</li> <li>判断线程池的线程是否都处于工作状态，若没有，创建一个新的工作线程来执行任务，否则，交给饱和策略来处理任务</li></ol></li> <li><p><code>ThreadPoolExecutor</code>执行<code>execute()</code>的4种情况：</p> <ol><li>当前运行的线程少于<code>corePoolSize</code>，创建新线程来执行任务（需要获取全局锁）</li> <li>运行的线程多余corePoolSize，将任务加入阻塞队列</li> <li>任务无法加入阻塞队列，则创建新线程来处理任务（需要全局锁）</li> <li>若创建新线程使得当前运行的线程数超出<code>maximumPoolSize</code>，任务被拒绝，调用<code>RejectExecutionHandler.rejectExecution()</code>处理</li></ol></li> <li><p>当线程池预热后，几乎所有的<code>execute()</code>方法执行的都是步骤二，避免获取全局锁，能得到更好的性能</p></li></ul> <h3 id="线程池的创建"><a href="#线程池的创建" class="header-anchor">#</a> 线程池的创建</h3> <ul><li><p>可以通过<code>ThreadPoolExecutor</code>来创建一个线程池，常用构造函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>参数说明：</p> <table><thead><tr><th>参数</th> <th>描述</th></tr></thead> <tbody><tr><td>corePoolSize</td> <td>核心线程池大小。核心线程池维持线程池中最基本的线程数量，即使是这些线程处于空闲状态其也会存在</td></tr> <tr><td>maximumPoolSize</td> <td>线程池允许的最大线程数量。当队列满了但还没有达到最大线程数时，线程池会再创建新的线程执行任务</td></tr> <tr><td>keepAliveTime</td> <td>控制除了核心线程池之外额外创建的线程的生命周期，即从线程空闲开始何时被终止</td></tr> <tr><td>unit</td> <td>keepAliveTime的时间单位</td></tr> <tr><td>workQueue</td> <td>用于保存等待执行的线程的阻塞队列，<br>如ArrayBlockingQueue、LinkedBlockingQueue、<br>SynchronousQueue、PriorityBlockingQueue</td></tr> <tr><td>threadFactory</td> <td>用于线程池创建线程的工厂，如此可以给线程指定有意义的名称等定制操作</td></tr> <tr><td>handler</td> <td>饱和策略。当队列和线程池都满了的情况下，如何处理新提交的任务。<br>默认使用AbortPolicy。<br>JDK1.5提供了4种策略：<br>AbortPolicy：直接抛出异常；<br>CallerRunsPolicy：只用调用者所在线程运行任务；<br>DiscardOldestPolicy：丢弃队列中最近的一个任务，执行当前任务；<br>DiscardPolicy：直接丢弃不处理</td></tr></tbody></table></li></ul> <h3 id="向线程池提交任务"><a href="#向线程池提交任务" class="header-anchor">#</a> 向线程池提交任务</h3> <ul><li>两种方法：
<ul><li><code>submit()</code>：用于提交<strong>需要返回值</strong>的任务，线程池会返回一个<code>Future</code>对象，通过此对象可以判断任务是否执行成功，并获取执行返回值。Future的<code>get()</code>方法会阻塞线程直到返回值</li> <li><code>execute()</code>：用于提交不需要返回值的任务，无法判断任务是否被线程池执行成功</li></ul></li></ul> <h3 id="关闭线程池"><a href="#关闭线程池" class="header-anchor">#</a> 关闭线程池</h3> <ul><li>通过<code>shutdown()</code>或者<code>shutdownNow()</code>方法关闭线程池，其原理是遍历线程池中的工作线程，逐个调用<code>interrupt()</code>方法来中断线程</li> <li>上述两个方法调用后，<code>isShutdown()</code>会返回true，而需要等待所有任务都关闭后，<code>isTerminated()</code>才返回true</li></ul> <h3 id="线程池的监控"><a href="#线程池的监控" class="header-anchor">#</a> 线程池的监控</h3> <ul><li><p>常用的监控属性：</p> <table><thead><tr><th>属性</th> <th>描述</th></tr></thead> <tbody><tr><td>taskCount</td> <td>线程池需要执行的任务数量</td></tr> <tr><td>completedTaskCount</td> <td>线程池再运行过程中已经完成的任务数量</td></tr> <tr><td>largestPoolSize</td> <td>曾经创建过的最大线程数量，通过此可知线程池是否满过</td></tr> <tr><td>getPoolSize</td> <td>线程池的线程数量</td></tr> <tr><td>getActiveCount</td> <td>活动的线程数</td></tr></tbody></table></li> <li><p>一般通过扩展线程池来实现监控。重写线程池的<code>beforeExecute()</code>、<code>afterExecute()</code>、<code>terminated()</code>方法可以在任务执行前后以及线程池关闭前执行一些代码来监控</p></li></ul> <h3 id="附加-源码中的解释"><a href="#附加-源码中的解释" class="header-anchor">#</a> 附加：源码中的解释</h3> <ul><li><p>CorePoolSize和MaximumPoolSize</p> <blockquote><p>Core and maximum pool sizes
A ThreadPoolExecutor will automatically adjust the pool size (see getPoolSize) according to the bounds set by corePoolSize (see getCorePoolSize) and maximumPoolSize (see getMaximumPoolSize). When a new task is submitted in method execute(Runnable), if fewer than corePoolSize threads are running, a new thread is created to handle the request, even if other worker threads are idle. Else if fewer than maximumPoolSize threads are running, a new thread will be created to handle the request only if the queue is full. By setting corePoolSize and maximumPoolSize the same, you create a fixed-size thread pool. By setting maximumPoolSize to an essentially unbounded value such as Integer.MAX_VALUE, you allow the pool to accommodate an arbitrary number of concurrent tasks. Most typically, core and maximum pool sizes are set only upon construction, but they may also be changed dynamically using setCorePoolSize and setMaximumPoolSize.</p></blockquote></li> <li><p>一开始线程池中的线程都是在任务提交时才创建，也可以使用<code>prestartCoreThread()</code>或<code>prestartAllCoreThread()</code>来提前创建线程</p> <blockquote><p>By default, even core threads are initially created and started only when new tasks arrive, but this can be overridden dynamically using method prestartCoreThread or prestartAllCoreThreads. You probably want to prestart threads if you construct the pool with a non-empty queue.</p></blockquote></li> <li><p>钩子(Hook)方法</p> <blockquote><p>Hook methods
This class provides protected overridable beforeExecute(Thread, Runnable) and afterExecute(Runnable, Throwable) methods that are called before and after execution of each task. These can be used to manipulate the execution environment; for example, reinitializing ThreadLocals, gathering statistics, or adding log entries. Additionally, method terminated can be overridden to perform any special processing that needs to be done once the Executor has fully terminated.</p></blockquote></li></ul> <h2 id="executor框架"><a href="#executor框架" class="header-anchor">#</a> Executor框架</h2> <ul><li>Java线程既是工作单元也是执行机制，从JDK5开始，用Runnable和Callable作为工作单元，而执行机制由Executor框架提供</li></ul> <h3 id="executor框架的结构与成员"><a href="#executor框架的结构与成员" class="header-anchor">#</a> Executor框架的结构与成员</h3> <ul><li>结构主要由三部分组成
<ul><li>任务：包括被执行任务需要实现的<code>Runnable</code>和<code>Callable</code>接口</li> <li>任务的执行：任务执行机制的核心接口<code>Executor</code>、以及继承自<code>Executor</code>的<code>ExecutorService</code>接口。两个实现了ExecutorService的类：<code>ThreadPoolExecutor</code>和<code>ScheduledThreadPoolExecutor</code></li> <li>异步计算的结果：包括<code>Future</code>和实现了<code>Future</code>接口的<code>FutureTask</code></li></ul></li> <li>使用：
<ol><li>创建实现Runnable或Callable接口的任务对象。工具类<code>Executors</code>可以将Runnable封装为Callable，使用<code>Executors.callable(Runnable task)</code>或<code>Executors.callable(Runnable task,Object result)</code></li> <li>提交给ExecutorService执行，分两种：
<ul><li>使用<code>execute()</code>直接执行：任务不需要返回结果是可以直接用此方法执行</li> <li>使用<code>submit()</code>提交后执行：需要返回结果时使用，该方法返回一个Future对象</li></ul></li> <li>使用<code>Future.get()</code>方法等待任务执行返回结果，也可以使用<code>Future.cancel()</code>取消任务的执行</li></ol></li> <li>Executor框架的主要成员：
<ul><li><code>ThreadPoolExecutor</code>：通常使用<code>Executors</code>工具类创建，包含
<ul><li>SingleThreadExecutor：使用LinkedBlockingQueue无界队列。适用于需要保证顺序地执行个任务场景</li> <li>FixedThreadPool：使用LinkedBlockingQueue无界队列。固定线程数，适用于需要限制线程数量的场景，如负载较重的服务器</li> <li>CachedThreadPool：使用SynchronousQueue队列，无界线程池，适用于执行很多短期异步任务的小程序或负载较轻的服务器</li></ul></li> <li><code>ScheduledThreadPoolExecutor</code>：通常使用<code>Executors</code>创建，包含
<ul><li>ScheduledThreadPoolExecutor：包含若干线程</li> <li>SingleThreadScheduledExecutor：只包含一个线程</li></ul></li> <li><code>Future</code>：异步计算的结果</li> <li><code>Runnable &amp; Callable</code>：要执行的任务需要实现的接口</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.969a6014.js" defer></script><script src="/assets/js/2.0c4bddf9.js" defer></script><script src="/assets/js/1.50b457b8.js" defer></script><script src="/assets/js/33.e9f62ae9.js" defer></script>
  </body>
</html>
