<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>概念 | Longqinx&#39;s Notes</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.9f84806b.css" as="style"><link rel="preload" href="/assets/js/app.9fc73bf5.js" as="script"><link rel="preload" href="/assets/js/2.0c4bddf9.js" as="script"><link rel="preload" href="/assets/js/1.50b457b8.js" as="script"><link rel="preload" href="/assets/js/25.56528869.js" as="script"><link rel="prefetch" href="/assets/js/10.325b9f09.js"><link rel="prefetch" href="/assets/js/11.845e3692.js"><link rel="prefetch" href="/assets/js/12.ecdb524b.js"><link rel="prefetch" href="/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/assets/js/15.b60f3925.js"><link rel="prefetch" href="/assets/js/16.85253907.js"><link rel="prefetch" href="/assets/js/17.c2838453.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/20.10e47ab9.js"><link rel="prefetch" href="/assets/js/21.33b300c9.js"><link rel="prefetch" href="/assets/js/22.271589f5.js"><link rel="prefetch" href="/assets/js/23.36377001.js"><link rel="prefetch" href="/assets/js/24.4b7aa88b.js"><link rel="prefetch" href="/assets/js/26.b52f2341.js"><link rel="prefetch" href="/assets/js/27.efe3c099.js"><link rel="prefetch" href="/assets/js/28.4b2afb08.js"><link rel="prefetch" href="/assets/js/29.3395be40.js"><link rel="prefetch" href="/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/assets/js/30.0f02679a.js"><link rel="prefetch" href="/assets/js/31.660f824f.js"><link rel="prefetch" href="/assets/js/32.e88c0552.js"><link rel="prefetch" href="/assets/js/33.707922df.js"><link rel="prefetch" href="/assets/js/34.7e9d365c.js"><link rel="prefetch" href="/assets/js/35.3dfd9ff7.js"><link rel="prefetch" href="/assets/js/36.6c8f895d.js"><link rel="prefetch" href="/assets/js/37.1a64224f.js"><link rel="prefetch" href="/assets/js/38.b9caece4.js"><link rel="prefetch" href="/assets/js/39.0a4f8509.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.167f9203.js"><link rel="prefetch" href="/assets/js/41.a4cc5d7f.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f84806b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Longqinx's Notes" class="logo"> <span class="site-name can-hide">Longqinx's Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/c++/" class="nav-link router-link-active">
  C/C++
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/dsa/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/project/" class="nav-link">
  我的小项目
</a></div><div class="nav-item"><a href="/blog/" class="nav-link">
  技术文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/contactMe.html" class="nav-link">
  联系我
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/c++/" class="nav-link router-link-active">
  C/C++
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/dsa/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/project/" class="nav-link">
  我的小项目
</a></div><div class="nav-item"><a href="/blog/" class="nav-link">
  技术文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于" class="mobile-dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/contactMe.html" class="nav-link">
  联系我
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/c++/C%E4%BD%8D%E5%9F%9F.html#概念" class="sidebar-link">概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/c++/C%E4%BD%8D%E5%9F%9F.html#示例-来自cppreference" class="sidebar-link">示例（来自cppreference）</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h2> <ul><li>位域（bit field）用于按位（bit）定义一个类（class/struct）成员的大小</li> <li>相邻的位域成员可能会共享单个字节</li> <li>位域的类型只能是<strong>整型（int/long/..）或</strong>枚举（enum）（通常是const-volatile修饰的）</li> <li>位域可以没有命名，未命名的位域指定了 <strong>填充位（padding bit）</strong> 大小</li> <li>未命名的位域不能被定义为cv-qualified（const-volatile）的类型</li> <li>位域不能用于静态成员</li> <li>不存在纯右值（prvalue）的位域</li> <li>位域中指定的位数会限制该成员所能存储数据的范围</li> <li>若通过位域指定的位数大于数据类型本身能存储的数据大小，则超过数据类型本身能存储的数据大小部分将作为填充位。如对于<code>std::uint8_t b:1000;</code>，其本身只能存储 0 ~ 255范围的值，多余的位将作为填充位</li> <li>因为位域并不需要一定从字节开始位存储，因此并不能获取位域的地址。指针或非常量引用位域是不可行的。当创建位域的一个常量引用时，会自动创建一个与位域类型相同的临时变量，该变量会复制位域的值，该常量引用引用的是临时变量</li> <li>一个结构体中的位域变量会按照定义顺序从字节低位开始存储</li></ul> <h2 id="示例-来自cppreference"><a href="#示例-来自cppreference" class="header-anchor">#</a> 示例（来自cppreference）</h2> <ul><li><p>example-1</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bit&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">S</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通常以下成员总共占据 2 字节:</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b1<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 第一个字节中的前三位是 b1</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 第一个字节中的紧接着两位作为填充位，不使用</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b2<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// b2占6位 - 无法在第一字节中存放（第一字节只剩3位，char按一字节对齐） =&gt; 从第二字节开始存放</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b3<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// b3占3位 - 第二字节还剩2位，刚好够用</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span> <span class="token comment">// usually prints 2</span>

    S s<span class="token punctuation">;</span>
    <span class="token comment">// set distinguishable field values</span>
    s<span class="token punctuation">.</span>b1 <span class="token operator">=</span> <span class="token number">0b111</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>b2 <span class="token operator">=</span> <span class="token number">0b101111</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>b3 <span class="token operator">=</span> <span class="token number">0b11</span><span class="token punctuation">;</span>

    <span class="token comment">// show layout of fields in S (c++ 20才有bit_cast)</span>
    <span class="token keyword">auto</span> i <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">bit_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span><span class="token keyword">uint16_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// usually prints 1110000011110111</span>
    <span class="token comment">// breakdown is:  \_/\/\_/\____/\/</span>
    <span class="token comment">//                 b1 u a   b2  b3</span>
    <span class="token comment">// where &quot;u&quot; marks the unused :2 specified in the struct, and</span>
    <span class="token comment">// &quot;a&quot; marks compiler-added padding to byte-align the next field.</span>
    <span class="token comment">// Byte-alignment is happening because b2's type is declared unsigned char;</span>
    <span class="token comment">// if b2 were declared uint16_t there would be no &quot;a&quot;, b2 would abut &quot;u&quot;.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> b <span class="token operator">=</span> i<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// print LSB-first（小端字节序）</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//可能输出结果：</span>
<span class="token number">2</span>
<span class="token number">1110000011110111</span>
</code></pre></div></li> <li><p>exmaple-2：大小为 0 的未命名位域有特殊含义，其可以强制打断（break up）填充。其让下一个相邻的位域从其分配单元开始存放</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">S</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通常占据 2 字节:</span>
    <span class="token comment">// b1占3位</span>
    <span class="token comment">// 5位未使用的填充位</span>
    <span class="token comment">// b2占 2 位</span>
    <span class="token comment">// 6位未使用</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b1<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//会强制下一个位域从新字节开始</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b2<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span> <span class="token comment">// usually prints 2</span>
    <span class="token comment">// would usually print 1 if not for</span>
    <span class="token comment">// the padding break in line 11</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9fc73bf5.js" defer></script><script src="/assets/js/2.0c4bddf9.js" defer></script><script src="/assets/js/1.50b457b8.js" defer></script><script src="/assets/js/25.56528869.js" defer></script>
  </body>
</html>
